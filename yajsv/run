#!/bin/bash
set -eu -o pipefail
CONTAINER_NAME=yajsv
IMAGE_NAME=timjdfletcher/${CONTAINER_NAME}
IMAGE_TAG=tmp
PLATFORMS="linux/amd64,linux/arm64"
TOOL="yajsv"
YAJSV_VERSION="v1.4.1"
GOSS_VERSION="v0.4.9"

log() {
  echo "==> $*"
}

_ensure_goss_volume() {
  if ! docker volume inspect goss-bin >/dev/null 2>&1; then
    log "Creating goss-bin volume..."
    docker volume create goss-bin
  fi
  
  # Download pinned goss version to volume (idempotent)
  log "Ensuring goss ${GOSS_VERSION} in volume..."
  docker run --rm \
    -v goss-bin:/target \
    --user root \
    --entrypoint sh \
    curlimages/curl:latest -c "
      if [ -f /target/goss ] && /target/goss --version 2>&1 | grep -q '${GOSS_VERSION}'; then
        echo 'goss ${GOSS_VERSION} already installed'
      else
        ARCH=\$(uname -m)
        case \$ARCH in
          x86_64)  GOSS_ARCH=amd64 ;;
          aarch64) GOSS_ARCH=arm64 ;;
          *)       echo \"Unsupported arch: \$ARCH\"; exit 1 ;;
        esac
        curl -fsSL \"https://github.com/goss-org/goss/releases/download/${GOSS_VERSION}/goss-linux-\${GOSS_ARCH}\" -o /target/goss
        chmod 755 /target/goss
        echo 'goss ${GOSS_VERSION} installed'
      fi
    "
}

build() {
  _buildx_setup
  docker buildx build --load --tag "${IMAGE_NAME}:${IMAGE_TAG}" --build-arg TOOL="${TOOL}" --file Dockerfile .
  docker tag "${IMAGE_NAME}:${IMAGE_TAG}" "${IMAGE_NAME}:latest"
}

clean() {
  docker image rm "${IMAGE_NAME}:${IMAGE_TAG}" || true
  docker image rm "${IMAGE_NAME}:latest" || true
  docker buildx prune --force
  docker buildx rm builder || true
}

usage() {
  echo "./run build   - Build a local image called ${IMAGE_NAME}:${IMAGE_TAG}"
  echo "./run test    - Build and run validation tests"
  echo "./run clean   - Remove images and prune builder"
  echo "./run release - Test and release multi-arch to Docker Hub"
}

test() {
  build
  _ensure_goss_volume

  log "Testing container artifact directly..."
  
  # Test default CMD shows correct pinned version
  log "Test: version is ${YAJSV_VERSION}"
  local actual_version
  actual_version=$(docker run --rm "${IMAGE_NAME}:${IMAGE_TAG}")
  if [ "${actual_version}" != "${YAJSV_VERSION}" ]; then
    echo "  FAIL: expected ${YAJSV_VERSION}, got ${actual_version}"
    exit 1
  fi
  echo "  PASS"

  # Test valid file passes
  log "Test: valid JSON passes validation"
  docker run --rm \
    -v "$(pwd)/test-data:/data:ro" \
    "${IMAGE_NAME}:${IMAGE_TAG}" \
    -s /data/schema.json /data/valid.json | grep -q "pass"
  echo "  PASS"

  # Test invalid file fails with exit code 1
  log "Test: invalid JSON fails with exit 1"
  if docker run --rm \
    -v "$(pwd)/test-data:/data:ro" \
    "${IMAGE_NAME}:${IMAGE_TAG}" \
    -s /data/schema.json /data/invalid-missing-required.json 2>&1; then
    echo "  FAIL: expected non-zero exit"
    exit 1
  else
    echo "  PASS"
  fi

  log "Running extended goss validation tests..."
  mkdir -p .tmp
  trap "rm -rf .tmp" EXIT

  # Extract yajsv binary (scratch image has no shell)
  local tmp_container
  tmp_container=$(docker create "${IMAGE_NAME}:${IMAGE_TAG}")
  docker cp "${tmp_container}:/yajsv" ".tmp/yajsv"
  docker rm "${tmp_container}" >/dev/null
  chmod 755 ".tmp/yajsv"

  # Run goss from volume in a debian container (yajsv needs glibc)
  docker run --rm \
    -v goss-bin:/goss-bin:ro \
    -v "$(pwd)/.tmp/yajsv:/usr/local/bin/yajsv:ro" \
    -v "$(pwd)/goss/tests:/goss:ro" \
    -v "$(pwd)/test-data:/data:ro" \
    debian:trixie-slim \
    /goss-bin/goss --gossfile /goss/goss-validation-tests.yaml validate

  log "All tests passed!"
}

find_release(){
  TAG="$(git tag | grep ^${CONTAINER_NAME} | sort -n | tail -n 1)"
  git checkout "${TAG}"
  export IMAGE_TAG=$TAG
}

_buildx_setup () {
  docker buildx use builder || docker buildx create --name builder
  docker buildx inspect --bootstrap
}

release() {
  find_release
  _buildx_setup
  docker buildx build --platform "${PLATFORMS}" --tag "${IMAGE_NAME}:${IMAGE_TAG}" --build-arg TOOLS="${TOOL}" --push --file Dockerfile .
  docker buildx build --platform "${PLATFORMS}" --tag "${IMAGE_NAME}:latest"       --build-arg TOOLS="${TOOL}" --push --file Dockerfile .
}

CMD=${1:-}

shift || true
case ${CMD} in
    build) build ;;
    test) test ;;
    clean) clean ;;
    release) test && find_release && clean && release ;;
    *) usage ;;
esac
