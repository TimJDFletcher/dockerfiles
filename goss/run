#!/bin/bash
set -eu -o pipefail

CONTAINER_NAME=goss
IMAGE_NAME=timjdfletcher/${CONTAINER_NAME}
IMAGE_TAG=tmp
PLATFORMS="linux/amd64,linux/arm64"

log() {
  echo "==> $*"
}

build() {
  _buildx_setup
  docker buildx build --load --tag "${IMAGE_NAME}:${IMAGE_TAG}" --file Dockerfile .
  docker tag "${IMAGE_NAME}:${IMAGE_TAG}" "${IMAGE_NAME}:latest"
}

test() {
  build
  log "Testing goss image..."
  
  # Test version output
  log "Test: goss --version"
  docker run --rm "${IMAGE_NAME}:${IMAGE_TAG}" --version | grep -q "goss version"
  echo "  PASS"
  
  # Test validate with inline gossfile
  log "Test: goss validate"
  docker run --rm --entrypoint sh "${IMAGE_NAME}:${IMAGE_TAG}" -c '
    echo "command:" > /tmp/test.yaml
    echo "  goss --version:" >> /tmp/test.yaml
    echo "    exit-status: 0" >> /tmp/test.yaml
    goss --gossfile /tmp/test.yaml validate
  '
  echo "  PASS"
  
  log "All tests passed!"
}

clean() {
  docker image rm "${IMAGE_NAME}:${IMAGE_TAG}" || true
  docker image rm "${IMAGE_NAME}:latest" || true
  docker buildx prune --force
  docker buildx rm builder || true
}

usage() {
  echo "./run build   - Build local image ${IMAGE_NAME}:${IMAGE_TAG}"
  echo "./run test    - Build and run basic tests"
  echo "./run clean   - Remove images and prune builder"
  echo "./run release - Test and release multi-arch to Docker Hub"
}

find_release() {
  TAG="$(git tag | grep ^${CONTAINER_NAME} | sort -n | tail -n 1)"
  git checkout "${TAG}"
  export IMAGE_TAG=$TAG
}

_buildx_setup() {
  docker buildx use builder || docker buildx create --name builder
  docker buildx inspect --bootstrap
}

release() {
  find_release
  _buildx_setup
  docker buildx build --platform "${PLATFORMS}" --tag "${IMAGE_NAME}:${IMAGE_TAG}" --push --file Dockerfile .
  docker buildx build --platform "${PLATFORMS}" --tag "${IMAGE_NAME}:latest" --push --file Dockerfile .
}

CMD=${1:-}

shift || true
case ${CMD} in
  build) build ;;
  test) test ;;
  clean) clean ;;
  release) test && find_release && clean && release ;;
  *) usage ;;
esac
