file:
  {{.Env.BACKUPDIR}}:
    exists: true
    mode: "0700"
    owner: {{.Env.USER}}
    group: {{.Env.USER}}
    filetype: directory

  # STRICT CHECK: Verifies bash calculation logic for QUOTA=1234
  {{.Env.BACKUPDIR}}/.com.apple.TimeMachine.quota.plist:
    exists: true
    mode: "0444"
    owner: root
    group: root
    filetype: file
    # Updated: 'contains' -> 'contents'
    contents: 
    - "<key>GlobalQuota</key>"
    - "1324997410816"

  {{.Env.BACKUPDIR}}/.com.apple.TimeMachine.supported:
    exists: true
    mode: "0444"
    owner: root
    group: root
    filetype: file

  {{.Env.BACKUPDIR}}/.metadata_never_index:
    exists: true
    mode: "0444"
    owner: root
    group: root
    filetype: file

  /etc/samba/smb.conf:
    exists: true
    mode: "0644"
    filetype: file
    # Updated: 'contains' -> 'contents'
    contents: 
    - "log level               = {{.Env.LOG_LEVEL}}"
    - "path                    = {{.Env.BACKUPDIR}}"

  /proc/1/cmdline:
    exists: true
    contents:
    - /usr/sbin/smbd

port:
  tcp:10445:
    listening: true
    ip:
    - 0.0.0.0

command:
  # 1. Config Validation
  /usr/bin/testparm --suppress-prompt --verbose:
    exit-status: 0
    stdout:
    - "fruit:time machine = yes"
    - "valid users = {{.Env.USER}}"
    - "path = {{.Env.BACKUPDIR}}"
    - "server min protocol = SMB3"
    stderr:
    - "Loaded services file OK."

  # 2. SMB Integration Test
  smb_integration_test:
    exec: "/usr/bin/smbclient //127.0.0.1/Data -U {{.Env.USER}}%{{.Env.PASS}} -I 127.0.0.1 -p 10445 -c 'mkdir smb_write_test; ls; rmdir smb_write_test'"
    exit-status: 0
    stdout:
    - "smb_write_test"
    - ".com.apple.TimeMachine.supported"
    timeout: 10000

process:
  smbd:
    running: true

mount:
  {{.Env.BACKUPDIR}}:
    exists: true

user:
  {{.Env.USER}}:
    exists: true
    uid: {{.Env.PUID}}
    gid: {{.Env.PGID}}
    groups:
    - {{.Env.USER}}
    home: {{.Env.BACKUPDIR}}
    shell: /usr/sbin/nologin

group:
  {{.Env.USER}}:
    exists: true
    gid: {{.Env.PGID}}
