#!/bin/bash
set -e -o pipefail

export USER="${USER:-timemachine}"
export PASS="${PASS:-password}"
export PUID="${PUID:-999}"
export PGID="${PGID:-999}"
export QUOTA="${QUOTA:-512000}"

checkBackupDir()
{
    printf "Backups will be written to: "
    if ! grep "${BACKUPDIR}" /proc/mounts | awk '{print $1}' ; then
        echo "error volume not found did you forget to add the volume?"
        exit 1
    fi
}

configureBackupDir()
{
    echo "Marking ${BACKUPDIR} as supported by timemmachine"
    touch "${BACKUPDIR}"/.com.apple.TimeMachine.supported

    echo "Changing ownership of ${BACKUPDIR} to ${PUID}:${PGID}, this may take a few minutes"
    chown -R "${PUID}":"${PGID}" "${BACKUPDIR}"

    echo "Restricting permissions on ${BACKUPDIR}, this may take a few minutes"
    chmod -R u+rwX,g=,o= "${BACKUPDIR}"
}

configureQuota()
{
    echo "Setting quote to ${QUOTA}MB"
    QUOTA_IN_MEGABYTES="${QUOTA}"
    QUOTA_IN_BYTES=$((QUOTA_IN_MEGABYTES * 1024 * 1024))
    sed "s/QUOTA_IN_MEGABYTES/${QUOTA_IN_MEGABYTES}/g" /etc/samba/smb.conf.tmpl \
      > /etc/samba/smb.conf
    sed "s/QUOTA_IN_BYTES/${QUOTA_IN_BYTES}/g" /etc/TimeMachine.quota.tmpl \
      > "${BACKUPDIR}"/.com.apple.TimeMachine.quota.plist

    chown root:root "${BACKUPDIR}"/.com.apple.TimeMachine.quota.plist
    chmod 444 "${BACKUPDIR}"/.com.apple.TimeMachine.quota.plist
}

createUser()
{
    echo "Creating system users"
    id -g timemachine > /dev/null || \
        addgroup --gid "$PGID" timemachine
    id -u timemachine > /dev/null || \
        useradd --uid "$PUID" --gid "$PGID" --home /backups --shell /bin/nologin --no-create-home timemachine
    echo "Creating SAMBA user ${USER}"
    printf "%s\n%s\n" "${PASS}" "${PASS}" | smbpasswd -a -s timemachine
    printf "timemachine = %s" "${USER}" > /etc/samba/users.map
}

startSMB()
{
    echo "==================================================================================="
    echo "=                 Starting SAMBA, logs after this are from SAMBA                  ="
    echo "==================================================================================="
    exec /usr/sbin/smbd --no-process-group --foreground "$@"
}

if [[ -z ${1} ]] || [[ ${1:0:1} == '-' ]] ; then
    echo "Configuring container as a timemachine backup target"
    checkBackupDir
    configureBackupDir
    configureQuota
    createUser
    startSMB "$@"
else
    exec "$@"
fi