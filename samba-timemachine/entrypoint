#!/bin/bash
set -e -o pipefail

# Helper to log with timestamps
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

checkBackupDir() {
    log "Checking backup volume..."
    if ! mountpoint -q "${BACKUPDIR}"; then
        log "WARNING: '${BACKUPDIR}' does not appear to be a mountpoint."
    fi

    if [ ! -d "${BACKUPDIR}" ]; then
        log "ERROR: Backup directory ${BACKUPDIR} does not exist."
        exit 1
    fi
}

cleanupLegacyFiles() {
    local legacy_quota_file="${BACKUPDIR}/.com.apple.TimeMachine.quota.plist"
    if [ -f "${legacy_quota_file}" ]; then
        log "Removing legacy quota file: ${legacy_quota_file}"
        rm -f "${legacy_quota_file}"
    fi
}

configureBackupDir() {
    log "Configuring directory permissions..."
    
    CURRENT_UID=$(stat -c '%u' "${BACKUPDIR}")
    CURRENT_GID=$(stat -c '%g' "${BACKUPDIR}")

    if [ "$CURRENT_UID" != "$PUID" ] || [ "$CURRENT_GID" != "$PGID" ]; then
        log "Fixing ownership of ${BACKUPDIR} root (non-recursive)..."
        chown "${PUID}:${PGID}" "${BACKUPDIR}"
        chmod 700 "${BACKUPDIR}"
    fi

    if [ "${FORCE_PERMISSIONS_RESET}" = "true" ]; then
        log "WARNING: FORCE_PERMISSIONS_RESET is set. Running recursive chown."
        chown -R "${PUID}:${PGID}" "${BACKUPDIR}"
        chmod -R u+rwX,g=,o= "${BACKUPDIR}"
    fi

    log "Generating Time Machine metadata..."
    touch "${BACKUPDIR}/.com.apple.TimeMachine.supported"
    touch "${BACKUPDIR}/.metadata_never_index"

    chown root:root "${BACKUPDIR}/.com.apple.TimeMachine.supported" \
                    "${BACKUPDIR}/.metadata_never_index"
    chmod 0444 "${BACKUPDIR}/.com.apple.TimeMachine.supported" \
               "${BACKUPDIR}/.metadata_never_index"

    log "Generating README..."
    envsubst < /templates/README.md > "${BACKUPDIR}/README.md"
    chown root:root "${BACKUPDIR}/README.md"
    chmod 0444 "${BACKUPDIR}/README.md"

    log "Copying backup check script..."
    cp /scripts/backup-check.sh "${BACKUPDIR}/backup-check.sh"
    chown root:root "${BACKUPDIR}/backup-check.sh"
    chmod +x "${BACKUPDIR}/backup-check.sh"
}

configureSAMBA() {
    log "Generating smb.conf..."
    # Ensure the directory exists just in case
    mkdir -p /etc/samba
    envsubst < /templates/smb.conf.tmpl > /etc/samba/smb.conf
}

createUser() {
    log "Configuring user ${USER} (UID: ${PUID}, GID: ${PGID})..."
    
    if ! getent group "$PGID" >/dev/null; then
        groupadd --gid "$PGID" "${USER}"
    else
        log "Group ID $PGID already exists, reusing it."
    fi

    if ! getent passwd "$PUID" >/dev/null; then
        useradd --uid "$PUID" --gid "$PGID" \
            --home-dir "${BACKUPDIR}" --no-create-home \
            --shell /usr/sbin/nologin \
            "${USER}"
    fi

    log "Setting Samba password..."
    # NOW SAFE: smb.conf exists, so smbpasswd knows where the database is
    printf "%s\n%s\n" "${PASS}" "${PASS}" | smbpasswd -a -s "${USER}"
    echo "${USER} = ${USER}" > /etc/samba/users.map
}

startSMB() {
    log "==================================================================="
    log " STARTING SAMBA (Log Level: ${LOG_LEVEL})"
    log "==================================================================="
    exec /usr/sbin/smbd --no-process-group --foreground --debug-stdout "$@"
}

if [[ -z ${1} ]] || [[ ${1:0:1} == '-' ]] ; then
    log "Initializing Time Machine Container..."
    
    checkBackupDir
    cleanupLegacyFiles
    
    # ORDER FIX: Configure Samba FIRST so smb.conf exists
    configureSAMBA
    
    # ORDER FIX: Create User SECOND so smbpasswd can read smb.conf
    createUser
    
    configureBackupDir
    startSMB "$@"
else
    exec "$@"
fi
