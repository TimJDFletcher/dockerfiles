#!/bin/bash
set -eu -o pipefail

IMAGE_NAME="timjdfletcher/samba-timemachine"
# Default to 'tmp' if not running a release
IMAGE_TAG="${IMAGE_TAG:-tmp}"
PLATFORMS="linux/amd64,linux/arm64"
TESTHOST="carbon"
GOSS_DST="/goss"
CONTAINER_NAME="samba-timemachine"

# --- Helper Functions ---

log() {
  echo "[$(date +'%H:%M:%S')] $1"
}

# Determine date command for macOS (BSD) vs Linux (GNU) compatibility
get_start_date() {
  if date --version >/dev/null 2>&1; then
    date -d '12 hours ago' +'%Y-%m-%d %H:%M:%S' # Linux
  else
    date -j -v-12H +'%Y-%m-%d %H:%M:%S' # macOS
  fi
}

wait_for_health() {
  log "Waiting for container to become healthy..."
  for _ in {1..30}; do
    if docker compose ps --format json | grep -q '"Health":"healthy"'; then
      log "Container is healthy!"
      return 0
    fi
    sleep 1
  done
  log "Timeout waiting for container health."
  return 1
}

# --- Core Tasks ---

build() {
  log "Building local image: ${IMAGE_NAME}:${IMAGE_TAG}"
  docker buildx build --load --tag "${IMAGE_NAME}:${IMAGE_TAG}" --file Dockerfile .
  docker tag "${IMAGE_NAME}:${IMAGE_TAG}" "${IMAGE_NAME}:latest"
}

clean() {
  log "Cleaning up..."
  docker compose down --volumes --remove-orphans || true
  docker image rm "${IMAGE_NAME}:${IMAGE_TAG}" "${IMAGE_NAME}:latest" 2>/dev/null || true
  docker buildx prune --force --filter "until=24h"
}

_up() {
  build
  log "Starting environment..."
  docker compose up --remove-orphans --detach
}

_down() {
  docker compose down --remove-orphans
}

_exec() {
  # Ensure we are up before exec
  if [ -z "$(docker compose ps -q)" ]; then
    log "Container not running. Starting up..."
    _up
  fi
  docker compose exec "${CONTAINER_NAME}" /bin/bash
}

# Run tests in a subshell to isolate ENV variables
_goss_test() {
  (
    # --- Setup ---
    log "--- Preparing Test Environment ---"
    export PUID=1234 PGID=4321 USER=testuser PASS=Password123 LOG_LEVEL=4
    local volume_name="samba-timemachine_backups"
    local test_file="/backups/permission-test-file"

    log "Cleaning up previous test runs..."
    docker compose down --volumes --remove-orphans 2>/dev/null || true
    docker volume create "${volume_name}" >/dev/null

    log "Creating test file with root ownership..."
    docker run --rm -v "${volume_name}:/backups" debian:stable-slim bash -c \
      "touch ${test_file} && chown root:root ${test_file}"

    # --- Phase 1: Test with FORCE_PERMISSIONS_RESET=false ---
    log "--- Running Test Phase 1: Default Permissions (No Reset) ---"
    export FORCE_PERMISSIONS_RESET="false"
    _up
    wait_for_health

    log "Running Live Validation..."
    docker compose exec "${CONTAINER_NAME}" \
      "${GOSS_DST}/goss" --gossfile "${GOSS_DST}/tests/goss-live-tests.yaml" validate

    log "Running Healthcheck Validation..."
    docker compose exec "${CONTAINER_NAME}" \
      "${GOSS_DST}/goss" --gossfile "${GOSS_DST}/tests/goss-healthcheck-tests.yaml" validate

    log "Running Permissions Check (Expecting root)..."
    docker compose exec -e EXPECTED_OWNER=root -e EXPECTED_GROUP=root "${CONTAINER_NAME}" \
      "${GOSS_DST}/goss" --gossfile "${GOSS_DST}/tests/goss-permissions-tests.yaml" validate

    log "Phase 1 Passed. Shutting down..."
    _down

    # --- Phase 2: Test with FORCE_PERMISSIONS_RESET=true ---
    log "--- Running Test Phase 2: Forced Permissions Reset ---"
    export FORCE_PERMISSIONS_RESET="true"
    _up
    wait_for_health

    log "Running Permissions Check (Expecting ${USER})..."
    docker compose exec -e EXPECTED_OWNER=${USER} -e EXPECTED_GROUP=${USER} "${CONTAINER_NAME}" \
      "${GOSS_DST}/goss" --gossfile "${GOSS_DST}/tests/goss-permissions-tests.yaml" validate

    log "Phase 2 Passed."
    log "--- All Tests Passed ---"
  )
  # --- Cleanup ---
  _down
  docker volume rm "samba-timemachine_backups" >/dev/null
}

_trivy() {
  build
  log "Running Trivy Scan..."
  trivy image \
      --severity HIGH,CRITICAL \
      --ignore-unfixed \
      --skip-files goss/goss \
      --exit-code 1 \
      "${IMAGE_NAME}:${IMAGE_TAG}"
}

# --- Release & Deployment ---

copyToTestHost() {
  local TEST_ARCH="amd64"
  log "Building for ${TEST_ARCH} and copying to ${TESTHOST}..."
  
  docker buildx build --platform "linux/${TEST_ARCH}" --tag "${IMAGE_NAME}:${TEST_ARCH}" --load --file Dockerfile .
  
  local size
  size=$(docker image inspect "${IMAGE_NAME}:${TEST_ARCH}" | jq -r '.[0].Size')
  
  docker save "${IMAGE_NAME}:${TEST_ARCH}" | \
    pigz -c | \
    pv -s "${size}" | \
    ssh -C "${TESTHOST}" "pigz -d | docker load"
}

timemachineLogs() {
  local filter='processImagePath contains "backupd" and subsystem beginswith "com.apple.TimeMachine"'
  local start
  start=$(get_start_date)

  echo ""
  echo "[History (from ${start})]"
  echo ""
  log show --style syslog --info --start "${start}" --predicate "${filter}"

  echo ""
  echo "[Following]"
  echo ""
  log stream --style syslog --info --predicate "$filter"
}

release() {
  # clean
  _goss_test
  _trivy

  # Find the latest tag on the current commit
  # We use --exact-match to ensure we are actually ON the tag we are releasing
  if ! CURRENT_TAG=$(git describe --tags --exact-match 2>/dev/null); then
    log "Error: Current commit is not tagged. Please tag the commit before releasing."
    exit 1
  fi
  
  log "Releasing version: ${CURRENT_TAG}"

  # Ensure builder exists
  if ! docker buildx inspect builder >/dev/null 2>&1; then
    docker buildx create --name builder --use
  fi
  
  log "Building and Pushing Multi-arch Image..."
  # Optimization: Build once, tag twice (version + latest), push immediately
  docker buildx build \
    --platform "${PLATFORMS}" \
    --tag "${IMAGE_NAME}:${CURRENT_TAG}" \
    --tag "${IMAGE_NAME}:latest" \
    --push \
    --file Dockerfile .
    
  log "Release ${CURRENT_TAG} complete."
}

usage() {
  cat <<EOF
Usage: ./run [COMMAND]

Commands:
  build             Build local image (${IMAGE_NAME}:${IMAGE_TAG})
  up                Build and start with docker compose
  down              Stop and remove containers
  exec              Build, start, and shell into container
  test              Run full GOSS test suite (Lifecycle + Healthcheck)
  trivy             Run security scan
  release           Test, Scan, Build Multi-arch, and Push tags to DockerHub
  copyToTestHost    Copy image to ${TESTHOST} via SSH
  timemachineLogs   Stream macOS TimeMachine logs
  clean             Remove images and prune builder
EOF
}

# --- Main Execution ---

CMD=${1:-}
shift || true

case ${CMD} in
    up)              _up ;;
    down)            _down ;;
    exec)            _exec ;;
    build)           build ;;
    clean)           clean ;;
    test)            _goss_test ;;
    trivy)           _trivy ;;
    copyToTestHost)  copyToTestHost ;;
    timemachineLogs) timemachineLogs ;;
    release)         release ;;
    help|--help|-h)  usage ;;
    *)               usage ;;
esac
