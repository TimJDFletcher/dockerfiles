#!/bin/bash
set -eu -o pipefail

# Ensure Docker daemon is running (macOS/Colima)
if ! docker info >/dev/null 2>&1; then
  echo "Docker not running. Starting Colima..."
  colima start
fi

IMAGE_NAME="timjdfletcher/ssh-audit"
IMAGE_TAG="${IMAGE_TAG:-tmp}"
PLATFORMS="linux/amd64,linux/arm64"
CONTAINER_NAME="ssh-audit"
SSH_AUDIT_VERSION="3.3.0"
CST_IMAGE="gcr.io/gcp-runtimes/container-structure-test:latest"

log() {
  echo "==> $1"
}

build() {
  log "Building local image: ${IMAGE_NAME}:${IMAGE_TAG}"
  docker buildx build --load --tag "${IMAGE_NAME}:${IMAGE_TAG}" --file Dockerfile .
  docker tag "${IMAGE_NAME}:${IMAGE_TAG}" "${IMAGE_NAME}:latest"
}

clean() {
  log "Cleaning up..."
  docker compose down --volumes --remove-orphans 2>/dev/null || true
  docker image rm "${IMAGE_NAME}:${IMAGE_TAG}" "${IMAGE_NAME}:latest" 2>/dev/null || true
  docker buildx prune --force --filter "until=24h"
}

_up() {
  build
  log "Starting test environment..."
  docker compose up --remove-orphans --detach
}

_down() {
  docker compose down --remove-orphans
}

wait_for_sshd() {
  log "Waiting for sshd containers to become healthy..."
  for _ in {1..45}; do
    local healthy_count
    healthy_count=$(docker compose ps --format json | grep -c '"Health":"healthy"' || true)
    if [ "$healthy_count" -ge 2 ]; then
      log "All sshd containers healthy!"
      return 0
    fi
    sleep 1
  done
  log "Timeout waiting for sshd containers."
  docker compose ps
  return 1
}

_test() {
  log "--- Running ssh-audit Tests ---"
  
  build
  
  # Phase 1: Build-time tests using Container Structure Test
  log "Running build-time tests with container-structure-test..."
  
  docker run --rm \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v "$(pwd)/container-structure-test:/tests:ro" \
    "${CST_IMAGE}" test \
    --image "${IMAGE_NAME}:${IMAGE_TAG}" \
    --config /tests/dockerfile-tests.yaml
  
  # Phase 2: Integration tests (requires docker-compose sshd containers)
  log "Starting test sshd containers..."
  docker compose up --remove-orphans --detach
  wait_for_sshd

  log "Running integration tests..."
  
  # Test hardened sshd - should pass with exit code 0
  log "Test: Hardened sshd passes audit..."
  local hardened_exit_code=0
  docker compose exec -T "${CONTAINER_NAME}" ssh-audit -p 2222 test-sshd >/dev/null 2>&1 || hardened_exit_code=$?
  if [ "${hardened_exit_code}" -ne 0 ]; then
    log "FAIL: Hardened sshd audit failed with exit code ${hardened_exit_code}"
    docker compose exec -T "${CONTAINER_NAME}" ssh-audit -p 2222 test-sshd 2>&1 | tail -20
    exit 1
  fi
  log "  PASS: Hardened sshd passes audit (exit code 0)"
  
  # Test weak sshd - should fail with exit code >= 2
  log "Test: Weak sshd fails audit..."
  local weak_exit_code=0
  docker compose exec -T "${CONTAINER_NAME}" ssh-audit -p 2222 weak-sshd >/dev/null 2>&1 || weak_exit_code=$?
  if [ "${weak_exit_code}" -lt 2 ]; then
    log "FAIL: Weak sshd should fail audit (exit code ${weak_exit_code})"
    exit 1
  fi
  log "  PASS: Weak sshd correctly fails audit (exit code ${weak_exit_code})"
  
  # Test JSON output (ignore exit code, just check output format)
  log "Test: JSON output works..."
  local json_output
  json_output=$(docker compose exec -T "${CONTAINER_NAME}" ssh-audit -p 2222 --json test-sshd 2>/dev/null || true)
  if ! echo "${json_output}" | grep -q '"banner":'; then
    log "FAIL: JSON output missing expected fields"
    echo "Output was: ${json_output}"
    exit 1
  fi
  log "  PASS: JSON output works"

  log "--- All Tests Passed ---"
  _down
}

_buildx_setup() {
  docker buildx use builder 2>/dev/null || docker buildx create --name builder --use
  docker buildx inspect --bootstrap
}

release() {
  _test

  if ! CURRENT_TAG=$(git describe --tags --exact-match 2>/dev/null); then
    log "Error: Current commit is not tagged. Please tag the commit before releasing."
    exit 1
  fi

  log "Releasing version: ${CURRENT_TAG}"
  _buildx_setup

  docker buildx build \
    --platform "${PLATFORMS}" \
    --tag "${IMAGE_NAME}:${CURRENT_TAG}" \
    --tag "${IMAGE_NAME}:latest" \
    --push \
    --file Dockerfile .

  log "Release ${CURRENT_TAG} complete."
}

usage() {
  cat <<EOF
Usage: ./run [COMMAND]

Commands:
  build    Build local image (${IMAGE_NAME}:${IMAGE_TAG})
  test     Run container-structure-test and integration tests
  clean    Remove images and prune builder
  release  Test, build multi-arch, and push to Docker Hub
EOF
}

CMD=${1:-}
shift || true

case ${CMD} in
    build)   build ;;
    test)    _test ;;
    clean)   clean ;;
    release) release ;;
    help|--help|-h) usage ;;
    *) usage ;;
esac
